<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>Prompt Builder</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .sidebar {
            min-width: 160px;
            max-width: 250px;
            padding-right: 0;
        }

        .sidebar .btn-mdfile {
            width: 100%;
            font-size: 0.85rem;
            padding: 0.25rem 0.5rem;
            margin-bottom: 4px;
            border-radius: 0.25rem;
            background: #f8f9fa;
            color: #333;
            border: 1px solid #e0e0e0;
            transition: background 0.2s;
        }

        .sidebar .btn-mdfile-selected {
            width: 100%;
            font-size: 0.85rem;
            padding: 0.25rem 0.5rem;
            margin-bottom: 4px;
            border-radius: 0.25rem;
            background: slategray;
            color: #333;
            border: 1px solid #e0e0e0;
            transition: background 0.2s;
        }

        .sidebar .btn-mdfile:hover {
            background: #e9ecef;
            color: #222;
        }

        .title-btns-table {
            width: 100%;
            margin-top: 10px;
        }

        .title-btns-table td {
            border: none;
            padding: 2px 4px;
        }

        .btn-title {
            font-size: 0.85rem;
            padding: 0.2rem 0.7rem;
            border-radius: 0.25rem;
            background: #f1f3f4;
            color: #333;
            border: 1px solid #e0e0e0;
            margin-bottom: 2px;
            width: 100%;
            transition: background 0.2s;
        }

        .btn-title:hover {
            background: #e2e6ea;
            color: #222;
        }

        .main-content {
            padding-left: 0;
        }

        #mainTextarea {
            min-height: 220px;
            font-size: 1rem;
        }

        .logo-text {
            font-family: 'Segoe UI', Arial, sans-serif;
            font-size: 2rem;
            font-weight: bold;
            color: #2c3e50;
            letter-spacing: 1px;
            text-shadow: 1px 1px 2px #e0e0e0;
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light mb-3">
        <div class="container-fluid">
            <span class="navbar-brand logo-text">PromptBuilder</span>
        </div>
    </nav>
    <div class="container-fluid mt-3">
        <div class="row">
            <div class="col-4 sidebar">
                <div id="fileButtons"></div>
            </div>
            <div class="col-8 main-content ms-3" style="padding-left: 1px;">
                <div class="mb-2">
                    <textarea id="mainTextarea" class="form-control" rows="12"></textarea>
                </div>
                <div class="d-flex mb-2">
                    <button id="adicionarBtn" class="btn btn-success me-2">Adicionar</button>
                    <button id="showBtn" class="btn btn-primary">Mostrar</button>
                </div>
                <div id="titleButtonsTableContainer"></div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="historyModal" tabindex="-1" aria-labelledby="historyModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="historyModalLabel">Histórico do Textarea</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <textarea id="modalTextarea" class="form-control" rows="10"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    <button type="button" class="btn btn-outline-primary" id="copyBtn">Copiar</button>
                    <button type="button" class="btn btn-success" id="saveBtn" style="display:none;">Salvar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Utilidades para requisições
        async function fetchJson(url, options = {}) {
            const res = await fetch(url, options);
            return res.json();
        }

        // Carrega botões de arquivos
        async function loadFileButtons() {
            const queryString = window.location.search;
            const urlParams = new URLSearchParams(queryString);

            const md = urlParams.get("md");
            let files;
            if (md) {
                files = await fetchJson('/api/agents/files?md=' + md);

            } else {
                files = await fetchJson('/api/agents/files');
            }
            const fileButtons = document.getElementById('fileButtons');
            fileButtons.innerHTML = '';
            files.forEach(file => {
                const btn = document.createElement('button');
                btn.className = 'btn btn-mdfile';
                btn.textContent = file.replace('.md', '');
                btn.onclick = async () => {
                    // Carrega o conteúdo completo do arquivo .md no textarea principal
                    const res = await fetch(`/api/agents/block/${file}/ALL`);
                    if (res.ok) {
                        const data = await res.json();
                        document.getElementById('mainTextarea').value = data.block || '';
                    } else {
                        document.getElementById('mainTextarea').value = '';
                    }
                    lastFile = file;
                    loadTitleButtonsTable(file);
                    updateFileButtonStates();
                };
                fileButtons.appendChild(btn);
            });
        }

        let lastFile = null;
        let selectedFiles = new Set();

        async function onFileClick(file) {
            const textarea = document.getElementById('mainTextarea');
            textarea.value = '';
            lastFile = file;
            loadTitleButtonsTable(file);
            updateFileButtonStates();
        }

        function updateFileButtonStates() {
            const fileButtons = document.getElementById('fileButtons').children;
            for (let btn of fileButtons) {
                const fileName = btn.textContent;
                if (selectedFiles.has(fileName)) {
                    btn.disabled = false;
                    btn.classList.add('btn-mdfile-selected');
                    //btn.classList.remove('btn-mdfile');
                } else {
                    btn.disabled = false;
                    btn.classList.remove('btn-mdfile-selected');
                    btn.classList.add('btn-mdfile');
                }
                // Adiciona funcionalidade de reabilitar/desmarcar ao clicar no botão já selecionado
                btn.onclick = function () {
                    if (selectedFiles.has(fileName)) {
                        selectedFiles.delete(fileName);
                        updateFileButtonStates();
                    } else {
                        onFileClick(fileName + '.md');
                    }
                };
            }
        }

        async function loadTitleButtonsTable(file) {
            const titles = await fetchJson(`/api/agents/titles/${file}`);
            const container = document.getElementById('titleButtonsTableContainer');
            container.innerHTML = '';
            if (!titles.length) return;
            const table = document.createElement('table');
            table.className = 'title-btns-table';
            let row;
            titles.forEach((title, idx) => {
                if (idx % 3 === 0) {
                    row = document.createElement('tr');
                    table.appendChild(row);
                }
                const td = document.createElement('td');
                const btn = document.createElement('button');
                btn.className = 'btn btn-title';
                btn.textContent = title;
                btn.onclick = () => onTitleClick(file, title);
                td.appendChild(btn);
                row.appendChild(td);
            });
            container.appendChild(table);
        }

        async function onTitleClick(file, title) {
            const items = await fetchJson(`/api/agents/items/${file}/${encodeURIComponent(title)}`);
            document.getElementById('mainTextarea').value = items.join('\n');
            // Marca o botão da esquerda como selecionado
            const fileName = file.replace('.md', '');
            selectedFiles.add(fileName);
            updateFileButtonStates();
        }

        // Mostrar modal com histórico
        async function showModal() {
            const res = await fetchJson('/api/agents/textarea/history');
            document.getElementById('modalTextarea').value = res.history;
            const modal = new bootstrap.Modal(document.getElementById('historyModal'));
            modal.show();
            document.getElementById('saveBtn').style.display = 'none';
        }

        document.getElementById('showBtn').onclick = showModal;
        document.getElementById('copyBtn').onclick = function () {
            const text = document.getElementById('modalTextarea').value;
            navigator.clipboard.writeText(text);
        };

        document.getElementById('modalTextarea').addEventListener('input', function () {
            document.getElementById('saveBtn').style.display = 'inline-block';
        });

        document.getElementById('saveBtn').onclick = async function () {
            const value = document.getElementById('modalTextarea').value;
            await fetch('/api/agents/textarea/replace', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ value })
            });
            document.getElementById('saveBtn').style.display = 'none';
        };

        // Variável para armazenar o conteúdo do prompt
        let promptValue = '';

        // Botão adicionar: adiciona o texto do textarea à variável promptValue
        const adicionarBtn = document.getElementById('adicionarBtn');
        adicionarBtn.onclick = async function () {
            const textarea = document.getElementById('mainTextarea');
            const value = textarea.value.trim();
            if (value) {
                await fetch('/api/agents/textarea', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ value })
                });
                textarea.value = '';
            }
        };

        window.onload = loadFileButtons;
    </script>
</body>

</html>